// 100% auto-generated by Source Genesys WebApi Front & Back Creator
// copyright © 2000-2025 Menphis - Sistemas Inteligentes
// This file is part of the Source Genesys project                     
#pragma warning disable IDE0130 // Namespace does not match folder structure

namespace MenphisSI.GerAdv.Validations;
#pragma warning restore IDE0130 // Namespace does not match folder structure

public partial interface IClientesValidation
{
    Task<bool> ValidateReg(Models.Clientes reg, IClientesService service, ICidadeReader cidadeReader, IRegimeTributacaoReader regimetributacaoReader, IEnquadramentoEmpresaReader enquadramentoempresaReader, [FromRoute, Required] string uri, MsiSqlConnection oCnn);
    Task<bool> CanDelete(int id, IClientesService service, IAgendaService agendaService, IAnexamentoRegistrosService anexamentoregistrosService, IClientesSociosService clientessociosService, IColaboradoresService colaboradoresService, IContaCorrenteService contacorrenteService, IContratosService contratosService, IDadosProcuracaoService dadosprocuracaoService, IDiario2Service diario2Service, IGruposEmpresasService gruposempresasService, IGruposEmpresasCliService gruposempresascliService, IHonorariosDadosContratoService honorariosdadoscontratoService, IHorasTrabService horastrabService, ILigacoesService ligacoesService, IOperadoresService operadoresService, IPreClientesService preclientesService, IProDespesasService prodespesasService, IReuniaoService reuniaoService, [FromRoute, Required] string uri, MsiSqlConnection oCnn);
}

public class ClientesValidation : IClientesValidation
{
    public async Task<bool> CanDelete(int id, IClientesService service, IAgendaService agendaService, IAnexamentoRegistrosService anexamentoregistrosService, IClientesSociosService clientessociosService, IColaboradoresService colaboradoresService, IContaCorrenteService contacorrenteService, IContratosService contratosService, IDadosProcuracaoService dadosprocuracaoService, IDiario2Service diario2Service, IGruposEmpresasService gruposempresasService, IGruposEmpresasCliService gruposempresascliService, IHonorariosDadosContratoService honorariosdadoscontratoService, IHorasTrabService horastrabService, ILigacoesService ligacoesService, IOperadoresService operadoresService, IPreClientesService preclientesService, IProDespesasService prodespesasService, IReuniaoService reuniaoService, [FromRoute, Required] string uri, MsiSqlConnection oCnn)
    {
        if (id <= 0)
            throw new SGValidationException("Id inválido");
        var reg = await service.GetById(id, uri, default);
        if (reg == null)
            throw new SGValidationException($"Registro com id {id} não encontrado.");
        var agendaExists0 = await agendaService.Filter(new Filters.FilterAgenda { Cliente = id }, uri);
        if (agendaExists0 != null && agendaExists0.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Compromisso associados a ele.");
        var anexamentoregistrosExists1 = await anexamentoregistrosService.Filter(new Filters.FilterAnexamentoRegistros { Cliente = id }, uri);
        if (anexamentoregistrosExists1 != null && anexamentoregistrosExists1.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Anexamento Registros associados a ele.");
        var clientessociosExists2 = await clientessociosService.Filter(new Filters.FilterClientesSocios { Cliente = id }, uri);
        if (clientessociosExists2 != null && clientessociosExists2.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Clientes Socios associados a ele.");
        var colaboradoresExists3 = await colaboradoresService.Filter(new Filters.FilterColaboradores { Cliente = id }, uri);
        if (colaboradoresExists3 != null && colaboradoresExists3.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Colaboradores associados a ele.");
        var contacorrenteExists4 = await contacorrenteService.Filter(new Filters.FilterContaCorrente { Cliente = id }, uri);
        if (contacorrenteExists4 != null && contacorrenteExists4.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Conta Corrente associados a ele.");
        var contratosExists5 = await contratosService.Filter(new Filters.FilterContratos { Cliente = id }, uri);
        if (contratosExists5 != null && contratosExists5.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Contratos associados a ele.");
        var dadosprocuracaoExists6 = await dadosprocuracaoService.Filter(new Filters.FilterDadosProcuracao { Cliente = id }, uri);
        if (dadosprocuracaoExists6 != null && dadosprocuracaoExists6.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Dados Procuracao associados a ele.");
        var diario2Exists7 = await diario2Service.Filter(new Filters.FilterDiario2 { Cliente = id }, uri);
        if (diario2Exists7 != null && diario2Exists7.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Diario2 associados a ele.");
        var gruposempresasExists8 = await gruposempresasService.Filter(new Filters.FilterGruposEmpresas { Cliente = id }, uri);
        if (gruposempresasExists8 != null && gruposempresasExists8.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Grupos Empresas associados a ele.");
        var gruposempresascliExists9 = await gruposempresascliService.Filter(new Filters.FilterGruposEmpresasCli { Cliente = id }, uri);
        if (gruposempresascliExists9 != null && gruposempresascliExists9.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Grupos Empresas Cli associados a ele.");
        var honorariosdadoscontratoExists10 = await honorariosdadoscontratoService.Filter(new Filters.FilterHonorariosDadosContrato { Cliente = id }, uri);
        if (honorariosdadoscontratoExists10 != null && honorariosdadoscontratoExists10.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Honorarios Dados Contrato associados a ele.");
        var horastrabExists11 = await horastrabService.Filter(new Filters.FilterHorasTrab { Cliente = id }, uri);
        if (horastrabExists11 != null && horastrabExists11.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Horas Trab associados a ele.");
        var ligacoesExists12 = await ligacoesService.Filter(new Filters.FilterLigacoes { Cliente = id }, uri);
        if (ligacoesExists12 != null && ligacoesExists12.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Ligacoes associados a ele.");
        var operadoresExists13 = await operadoresService.Filter(new Filters.FilterOperadores { Cliente = id }, uri);
        if (operadoresExists13 != null && operadoresExists13.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Operadores associados a ele.");
        var preclientesExists14 = await preclientesService.Filter(new Filters.FilterPreClientes { IDRep = id }, uri);
        if (preclientesExists14 != null && preclientesExists14.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Pre Clientes associados a ele.");
        var prodespesasExists15 = await prodespesasService.Filter(new Filters.FilterProDespesas { Cliente = id }, uri);
        if (prodespesasExists15 != null && prodespesasExists15.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Pro Despesas associados a ele.");
        var reuniaoExists16 = await reuniaoService.Filter(new Filters.FilterReuniao { Cliente = id }, uri);
        if (reuniaoExists16 != null && reuniaoExists16.Any())
            throw new SGValidationException("Não é possível excluir o registro, pois existem registros da tabela Reunião associados a ele.");
        return true;
    }

    private bool ValidSizes(Models.Clientes reg)
    {
        if (reg.Icone != null && reg.Icone.Length > 255)
            throw new SGValidationException($"Icone deve ter no máximo 255 caracteres.");
        if (reg.NomeMae != null && reg.NomeMae.Length > 80)
            throw new SGValidationException($"NomeMae deve ter no máximo 80 caracteres.");
        if (reg.QuemIndicou != null && reg.QuemIndicou.Length > 80)
            throw new SGValidationException($"QuemIndicou deve ter no máximo 80 caracteres.");
        if (reg.Nome != null && reg.Nome.Length > 80)
            throw new SGValidationException($"Nome deve ter no máximo 80 caracteres.");
        if (reg.NomeFantasia != null && reg.NomeFantasia.Length > 80)
            throw new SGValidationException($"NomeFantasia deve ter no máximo 80 caracteres.");
        if (reg.Class != null && reg.Class.Length > 1)
            throw new SGValidationException($"Class deve ter no máximo 1 caracteres.");
        if (reg.InscEst != null && reg.InscEst.Length > 15)
            throw new SGValidationException($"InscEst deve ter no máximo 15 caracteres.");
        if (reg.Qualificacao != null && reg.Qualificacao.Length > 100)
            throw new SGValidationException($"Qualificacao deve ter no máximo 100 caracteres.");
        if (reg.CNPJ != null && reg.CNPJ.Length > 14)
            throw new SGValidationException($"CNPJ deve ter no máximo 14 caracteres.");
        if (reg.CPF != null && reg.CPF.Length > 11)
            throw new SGValidationException($"CPF deve ter no máximo 11 caracteres.");
        if (reg.RG != null && reg.RG.Length > 50)
            throw new SGValidationException($"RG deve ter no máximo 50 caracteres.");
        if (reg.Endereco != null && reg.Endereco.Length > 80)
            throw new SGValidationException($"Endereco deve ter no máximo 80 caracteres.");
        if (reg.Bairro != null && reg.Bairro.Length > 50)
            throw new SGValidationException($"Bairro deve ter no máximo 50 caracteres.");
        if (reg.CEP != null && reg.CEP.Length > 10)
            throw new SGValidationException($"CEP deve ter no máximo 10 caracteres.");
        if (reg.HomePage != null && reg.HomePage.Length > 60)
            throw new SGValidationException($"HomePage deve ter no máximo 60 caracteres.");
        if (reg.NomePai != null && reg.NomePai.Length > 80)
            throw new SGValidationException($"NomePai deve ter no máximo 80 caracteres.");
        if (reg.RGOExpeditor != null && reg.RGOExpeditor.Length > 30)
            throw new SGValidationException($"RGOExpeditor deve ter no máximo 30 caracteres.");
        if (reg.CNH != null && reg.CNH.Length > 100)
            throw new SGValidationException($"CNH deve ter no máximo 100 caracteres.");
        if (reg.PessoaContato != null && reg.PessoaContato.Length > 120)
            throw new SGValidationException($"PessoaContato deve ter no máximo 120 caracteres.");
        if (reg.GUID != null && reg.GUID.Length > 150)
            throw new SGValidationException($"GUID deve ter no máximo 150 caracteres.");
        return true;
    }

    public async Task<bool> ValidateReg(Models.Clientes reg, IClientesService service, ICidadeReader cidadeReader, IRegimeTributacaoReader regimetributacaoReader, IEnquadramentoEmpresaReader enquadramentoempresaReader, [FromRoute, Required] string uri, MsiSqlConnection oCnn)
    {
        if (reg == null)
            throw new SGValidationException("Objeto está nulo");
        if (string.IsNullOrWhiteSpace(reg.Nome))
            throw new SGValidationException("Nome é obrigatório");
        var validSizes = ValidSizes(reg);
        if (!validSizes)
            return false;
        if (reg.EMail.Length > 0 && !reg.EMail.IsValidEmail())
            throw new SGValidationException($"EMail em formato inválido.");
        if (!string.IsNullOrWhiteSpace(reg.CPF))
        {
            var testaCpf = await IsCpfDuplicado(reg, service, uri);
            if (testaCpf.Item1 && testaCpf.Item2 != null)
            {
                throw new SGValidationException($"Clientes ({testaCpf.Item2.Nome}) com cpf '{reg.CPF.MaskCpf()}' já cadastrado.");
            }
            else if (testaCpf.Item1)
            {
                throw new SGValidationException($"Clientes com cpf '{reg.CPF.MaskCpf()}' já cadastrado.");
            }
        }

        if (!string.IsNullOrWhiteSpace(reg.CNPJ) && await IsCnpjDuplicado(reg, service, uri))
            throw new SGValidationException($"Clientes com cnpj {reg.CNPJ.MaskCnpj()} já cadastrado.");
        // Cidade
        if (!reg.Cidade.IsEmptyIDNumber())
        {
            var regCidade = await cidadeReader.Read(reg.Cidade, oCnn);
            if (regCidade == null || regCidade.Id != reg.Cidade)
            {
                throw new SGValidationException($"Cidade não encontrado ({regCidade?.Id}).");
            }
        }

        // RegimeTributacao
        if (!reg.RegimeTributacao.IsEmptyIDNumber())
        {
            var regRegimeTributacao = await regimetributacaoReader.Read(reg.RegimeTributacao, oCnn);
            if (regRegimeTributacao == null || regRegimeTributacao.Id != reg.RegimeTributacao)
            {
                throw new SGValidationException($"Regime Tributacao não encontrado ({regRegimeTributacao?.Id}).");
            }
        }

        // EnquadramentoEmpresa
        if (!reg.EnquadramentoEmpresa.IsEmptyIDNumber())
        {
            var regEnquadramentoEmpresa = await enquadramentoempresaReader.Read(reg.EnquadramentoEmpresa, oCnn);
            if (regEnquadramentoEmpresa == null || regEnquadramentoEmpresa.Id != reg.EnquadramentoEmpresa)
            {
                throw new SGValidationException($"Enquadramento Empresa não encontrado ({regEnquadramentoEmpresa?.Id}).");
            }
        }

        return true;
    }

    private async Task<bool> IsCnpjDuplicado(Models.Clientes reg, IClientesService service, string uri)
    {
        if (reg.CNPJ.Length == 0)
            return false;
        var existingClientes = (await service.Filter(new Filters.FilterClientes { CNPJ = reg.CNPJ.ClearInputCnpj() }, uri)).FirstOrDefault();
        return existingClientes != null && existingClientes.Id > 0 && existingClientes.Id != reg.Id;
    }

    private async Task<(bool, ClientesResponseAll? )> IsCpfDuplicado(Models.Clientes reg, IClientesService service, string uri)
    {
        if (reg.CPF.Length == 0)
            return (false, null);
        var existingClientes = (await service.Filter(new Filters.FilterClientes { CPF = reg.CPF.ClearInputCpf() }, uri)).FirstOrDefault();
        return (existingClientes != null && existingClientes.Id > 0 && existingClientes.Id != reg.Id, existingClientes);
    }
}