// 100% auto-generated by Source Genesys WebApi Front & Back Creator
// copyright © 2000-2025 Menphis - Sistemas Inteligentes
// This file is part of the Source Genesys project                     
#pragma warning disable IDE0130 // Namespace does not match folder structure

namespace MenphisSI.GerAdv.Readers;
#pragma warning restore IDE0130 // Namespace does not match folder structure

public partial class ProcessosReader
{
    private static string BuildSqlQuery(string campos, string whereClause, string orderClause, int max, MsiSqlConnection? oCnn = null)
    {
        if (max <= 0)
        {
            max = 200;
        }

        var orderQuery = $"{TSql.OrderBy} {DBProcessosDicInfo.CampoNome}";
        if (!string.IsNullOrEmpty(orderClause))
        {
            orderQuery = (!orderClause.ToUpperInvariant().Contains(TSql.OrderBy, StringComparison.OrdinalIgnoreCase) ? TSql.OrderBy : string.Empty) + orderClause;
        }

        var cWhere = whereClause.IsEmpty() ? string.Empty : (whereClause.Contains("WHERE", StringComparison.CurrentCultureIgnoreCase) ? whereClause : $" WHERE {whereClause}");
        var query = $@"SELECT TOP ({max})
                   {campos}, [{DBAdvogadosDicInfo.PTabelaNome}].[{DBAdvogadosDicInfo.Nome}],[{DBJusticaDicInfo.PTabelaNome}].[{DBJusticaDicInfo.Nome}],[{DBAdvogadosDicInfo.PTabelaNome}].[{DBAdvogadosDicInfo.Nome}],[{DBPrepostosDicInfo.PTabelaNome}].[{DBPrepostosDicInfo.Nome}],[{DBClientesDicInfo.PTabelaNome}].[{DBClientesDicInfo.Nome}],[{DBOponentesDicInfo.PTabelaNome}].[{DBOponentesDicInfo.Nome}],[{DBAreaDicInfo.PTabelaNome}].[{DBAreaDicInfo.Descricao}],[{DBCidadeDicInfo.PTabelaNome}].[{DBCidadeDicInfo.Nome}],[{DBSituacaoDicInfo.PTabelaNome}].[{DBSituacaoDicInfo.}],[{DBRitoDicInfo.PTabelaNome}].[{DBRitoDicInfo.Descricao}],[{DBAtividadesDicInfo.PTabelaNome}].[{DBAtividadesDicInfo.Descricao}]
                   FROM {DBProcessos.PTabelaNome.dbo(oCnn)}
                   LEFT JOIN {DBAdvogadosDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBAdvogadosDicInfo.PTabelaNome}].[{DBAdvogados.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.AdvOpo}]
LEFT JOIN {DBJusticaDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBJusticaDicInfo.PTabelaNome}].[{DBJustica.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Justica}]
LEFT JOIN {DBAdvogadosDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBAdvogadosDicInfo.PTabelaNome}].[{DBAdvogados.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Advogado}]
LEFT JOIN {DBPrepostosDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBPrepostosDicInfo.PTabelaNome}].[{DBPrepostos.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Preposto}]
LEFT JOIN {DBClientesDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBClientesDicInfo.PTabelaNome}].[{DBClientes.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Cliente}]
LEFT JOIN {DBOponentesDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBOponentesDicInfo.PTabelaNome}].[{DBOponentes.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Oponente}]
LEFT JOIN {DBAreaDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBAreaDicInfo.PTabelaNome}].[{DBArea.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Area}]
LEFT JOIN {DBCidadeDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBCidadeDicInfo.PTabelaNome}].[{DBCidade.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Cidade}]
LEFT JOIN {DBSituacaoDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBSituacaoDicInfo.PTabelaNome}].[{DBSituacao.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Situacao}]
LEFT JOIN {DBRitoDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBRitoDicInfo.PTabelaNome}].[{DBRito.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Rito}]
LEFT JOIN {DBAtividadesDicInfo.PTabelaNome.dbo(oCnn)} ON [{DBAtividadesDicInfo.PTabelaNome}].[{DBAtividades.CampoCodigo}]=[{DBProcessosDicInfo.PTabelaNome}].[{DBProcessosDicInfo.Atividade}]
 
                   {cWhere}
                   {orderQuery}
                   OPTION (OPTIMIZE FOR UNKNOWN)";
        return query;
    }

    public async Task<string> ReadStringAuditor(int id, string uri, MsiSqlConnection? oCnn)
    {
        if (oCnn is null)
            return string.Empty;
        string query = $@"{ConfiguracoesDBT.SQLNoCount}
SELECT TOP (1) 
    FORMAT(proDtAtu, 'yyyy-MM-dd-HH-mm-ss')
FROM {oCnn.UseDbo}.Processos WITH (NOLOCK, INDEX = idx_Processos_AuditorDtAtu)
WHERE proCodigo = @id
OPTION (OPTIMIZE FOR (@id UNKNOWN), FAST 1);";
        using var cmd = new SqlCommand(query, oCnn.InnerConnection);
        cmd.Parameters.AddWithValue("@id", id);
        var dataFormatada = $"{await cmd.ExecuteScalarAsync()}";
        return dataFormatada;
    }

    public async Task<string> ReadStringAuditor(string uri, string cWhere, List<SqlParameter> parameters, MsiSqlConnection? oCnn)
    {
        if (oCnn is null)
            return string.Empty;
        string query = $@"{ConfiguracoesDBT.SQLNoCount}
SELECT TOP (1) 
    FORMAT(
        CASE 
            WHEN proDtAtu IS NULL THEN proDtCad 
            WHEN proDtAtu > proDtCad THEN proDtAtu 
            ELSE proDtCad 
        END, 'yyyy-MM-dd-HH-mm-ss') AS data
FROM {oCnn.UseDbo}.Processos
        {(cWhere.Trim().Equals("") ? "" : $" WHERE {cWhere}")}
ORDER BY 
    CASE 
        WHEN proDtAtu IS NULL THEN proDtCad 
        WHEN proDtAtu > proDtCad THEN proDtAtu 
        ELSE proDtCad 
    END DESC;";
        using var cmd = new SqlCommand(query, oCnn.InnerConnection);
        foreach (var param in parameters)
        {
            if (!cmd.Parameters.Contains(param.ParameterName))
            {
                var newParam = new SqlParameter(param.ParameterName, param.Value)
                {
                    SqlDbType = param.SqlDbType,
                    Direction = param.Direction,
                    Size = param.Size,
                    Precision = param.Precision,
                    Scale = param.Scale
                };
                cmd.Parameters.Add(newParam);
            }
        }

        var dataFormatada = $"{await cmd.ExecuteScalarAsync()}";
        return dataFormatada;
    }
}